\newpage
\section{Aufbau und Konfiguration}\label{sec:aufbau}
In \autoref{fig:aufbau} wird grundlegend dargestellt,
wie die im vorigen Kapitel beschriebenen Komponenten miteinander verbunden sind.
Hierbei ist anzumerken, dass Verbindungen über (W)LAN indirekt über einen Router erstellt werden.
Zur Wahrung der Übersichtlichkeit zeigt die Abbildung
 lediglich die abstrakten Verbindungen auf Anwendungsebene.

\begin{figure}[ht!]
    \centering
    \resizebox{\textwidth}{!}{
        \input{assets/uml/Aufbau.latex}
    }
    \caption{Aufbau}
    \label{fig:aufbau}
\end{figure}

Im Folgenden werden die verschiedenen Konfigurationen der einzelnen Geräte vorgestellt.

\subsection{Harmony Hub}\label{sec:aufbau-hub}
Der Harmony Hub ist über WLAN mit dem Heimnetzwerk verbunden.
Angesteuert wird er per Funk über die zugehörige Fernbedienung.
Der Hub ist an die Playstation 4 über Bluetooth als Fernbedienung angeschlossen.
Hierzu ist im Vorfeld das bei Bluetooth-Geräten übliche \enquote{Pairing} notwendig.
Außerdem ist er an den Raspberry Pi per LAN angeschlossen.

\subsection{Raspberry Pi / Hassbian}\label{sec:aufbau-hassbian}

\paragraph{LAN-Schnittstelle}
Auf dem Raspberry Pi ist das Betriebssystem \textit{Hassbian} installiert.
Der darin enthaltene Home Assistant emuliert die sogenannte \textit{Hue Bridge} \cite{Emulated83:online}.
Eigentlich ist die \textit{Hue Bridge} zentraler Bestandteil des smarten Lampensystems der Marke Phillips \cite{HueBridg65:online}.
In Home Assistant wird die emulierte Bridge genutzt, um eine Verbindung zum Harmony Hub herzustellen.
Home Assistant stellt hierzu sogenannte \textit{Schalter} bereit, welche über die \textit{Hue API} an den Harmony Hub als Leuchten präsentiert werden.
Aus Sicht des Hubs kommuniziert er mit einer \enquote{normalen} \textit{Hue Bridge}.
Jedoch lassen sich über die Schalter mehr als nur Lichter steuern.
Eine weitere Möglichkeit ist das in diesem Projekt genutzte Ausführen von Kommandozeilenbefehlen über eine entsprechende Schnittstelle (\ac{cli})
indem hierfür spezielle Schalter konfiguriert werden.

\paragraph{Steuern der \ac{ps4}}
Das \ac{cli} wird genutzt, um die Playstation 4 unter Nutzung des Programms \textit{ps4-waker} \cite{dhleongp12:online} zu steuern.
Doch wieso wird ein solch komplexer Aufbau benötigt, wenn der Harmony Hub bereits eine direkte Bluetooth-Verbindung zur Playstation 4 besitzt?
Die Playstation lässt sich zwar per Bluetooth steuern,
kann auf diesem Weg allerdings nicht eingeschaltet werden.
Das Programm \textit{ps4-waker} hingegen erlaubt es die \ac{ps4} ein- sowie auszuschalten und sogar Anwendungen zu starten.

Das Einschalten geschieht über einen Befehl der Form \lstinline[language=bash]{ps4-waker -d 192.168.178.34  -c ~/.homeassistant/.ps4-wake.credentials.json}.
Durch \lstinline[language=bash]{-d} wird hierbei die IP-Adresse des Gerätes und
durch \lstinline[language=bash]{-c} die Datei,
welche die notwendigen Zugangsdaten enthält, angegeben.

Die Zugangsdaten werden zuvor durch folgendes Pairing-Verfahren ermittelt:
\begin{enumerate}
    \setlength\itemsep{-0.5em}
    \item \textit{ps4-waker} gibt sich beim ersten Start als Playstation 4 aus.
    \item Mit einem Smartphone versucht man sich über die entsprechende App mit der falschen \ac{ps4} zu verbinden.
    \item \textit{ps4-waker} nutzt die so übertragenen Informationen, um sich gegenüber der echten \ac{ps4} als Smartphone-App auszugeben.
    \item Die so erhaltenen Zugangsdaten werden in einer JSON-Datei gespeichert.
\end{enumerate}

Durch Anhängen des Schlüsselworts \enquote{\lstinline[language=bash]{standby}} kann die
\ac{ps4} wieder ausgeschaltet werden.

Der Home Assistant wird so konfiguriert,
dass die Befehle des \textit{ps4-waker} über einen Schalter ausgeführt werden können.
In \autoref{lst:ps4_switch} ist die Konfiguration des Schalters dargestellt,
welcher zum Ein- und Ausschalten der Playstation 4 dient.
Der Schalter wiederum ist automatisch durch die emulierte \textit{Hue Bridge} als Leuchte zugänglich.

\lstinputlisting[
    caption=Konfiguration des Schalters,
    label=lst:ps4_switch,
    language=yaml
]{ps4_switch.yaml}

Die erste Zeile gibt die eindeutige ID für den Schalter an.
Durch den \lstinline[language=yaml]{friendly_name} kann zusätzlich ein nutzerfreundlicher Name zur Anzeige auf Benutzeroberflächen angegeben werden.

Der aktuelle Zustand des Schalters wird mit \lstinline[language=yaml]{command_state}
und \\
\lstinline[language=yaml]{value_template} ermittelt.
Der Kommandozeilenbefehl unter \lstinline[language=yaml]{command_state} wird regelmäßig ausgeführt.
Als Ergebnis liefert er die in \autoref{lst:ps4-waker_search} dargestellten Daten im JSON-Format.
In \lstinline[language=yaml]{value_template} wird auf dieses JSON über
\lstinline[language=yaml]{'value_json'} zugegriffen.
Genauer gesagt wird geprüft,
ob das Feld \lstinline[language=json]{"statusCode"} den Wert
\lstinline[language=json]{"200"} enthält.
Ist dies der Fall, so gilt der Schalter als eingeschaltet, andernfalls als ausgeschaltet.

\lstinputlisting[
    caption=Antwort von \textit{ps4-waker search}-Befehl (gekürzt),
    label=lst:ps4-waker_search,
    language=json
]{ps4-waker_search.json}

Je nach aktuellem Status des Schalters führt ein Betätigen dazu, dass der Kommandozeilenbefehl unter \lstinline[language=yaml]{command_on} zum Einschalten
oder der unter \lstinline[language=yaml]{command_off} zum Ausschalten ausgeführt wird.
Beides wird über die jeweiligen Befehle von \textit{ps4-waker} umgesetzt.

\subsection{Netzadressen}\label{sec:aufbau-adressen}
Die folgende Tabelle zeigt die jeweiligen IP- und MAC-Adressen anhand welcher die
späteren Paketmitschnitte analysiert werden. \\

\begin{center}
    \begin{tabular}{l||c|c}
        Gerät           & IP-Adresse                &  MAC-Adresse          \\
        \hline
        \hline
        Harmony Hub     & \texttt{192.168.178.21}  &  \texttt{C8:DB:26:00:D0:E9}  \\
        \hline
        Raspberry Pi    & \texttt{192.168.178.45}  &  \texttt{B8:27:EB:9F:0E:FE}  \\
        \hline
        Playstation     & \texttt{192.168.178.34}  &  \texttt{80:EA:23:19:B6:5C}   \\
    \end{tabular}
\end{center}

